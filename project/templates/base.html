<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - Heritage Foods</title>
    
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="icon" href="{{ url_for('static', filename='heritage-logo.png') }}">
    
    
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appModal', () => ({
                isOpen: false,
                title: 'Confirm',
                message: 'Are you sure?',
                isConfirm: false,
                
                _resolve: null,
                _reject: null,

                open(type, title, message) {
                    this.isOpen = true;
                    this.type = type;
                    this.title = title;
                    this.message = message;
                    this.isConfirm = (type === 'confirm');
                    
                    return new Promise((resolve, reject) => {
                        this._resolve = resolve;
                        this._reject = reject;
                    });
                },

                accept() {
                    this.isOpen = false;
                    this._resolve(true);
                },
                
                cancel() {
                    this.isOpen = false;
                    this._resolve(false); 
                }
            }));
        });

        // Create a simple global helper object
        window.app = {
            alert(title, message) {
                window.dispatchEvent(new CustomEvent('open-modal', { 
                    detail: { type: 'alert', title, message }
                }));
            },
            confirm(title, message) {
                return window.dispatchEvent(new CustomEvent('open-modal', { 
                    detail: { type: 'confirm', title, message }
                })).detail;
            }
        };

        // ---
        // This is the global helper for all delete forms
        // ---
        async function handleAsyncSubmit(form, title, message) {
            event.preventDefault(); 
            
            const confirmed = await window.app.confirm(title, message);
            if (confirmed) {
                form.submit();
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; 
        }
        .heritage-green { color: #0A8445; }
        .bg-heritage-green { background-color: #0A8445; }
        .hover\:bg-heritage-green-dark:hover { background-color: #086F3A; }
        .focus\:ring-heritage-green:focus { --tw-ring-color: #0A8445; }
        .border-heritage-green { border-color: #0A8445; }
        
        .heritage-red { color: #D82232; }
        .bg-heritage-red { background-color: #D82232; }
        .hover\:bg-heritage-red-dark:hover { background-color: #B91C2A; }

        .heritage-orange { color: #f7941e; }
        .bg-heritage-orange { background-color: #f7941e; }

        /* --- Form Field Consistency --- */
        input[type="password"],
        input[type="text"],
        input[type="date"],
        select {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background: white !important;
            border-width: 1px !important;
            border-color: #d1d5db !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
            padding: 0.75rem 1rem !important;
            display: block !important;
            width: 100% !important;
            height: 3rem !important;
            font-size: 1rem !important;
            line-height: 1.5rem !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem !important;
        }
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: 2px solid transparent !important;
            outline-offset: 2px !important;
            box-shadow: 0 0 0 2px #0A8445, 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
            border-color: #0A8445 !important;
        }
        /* --- End Form Fixes --- */

        .public-bg {
            background-color: #f0fdf4; 
        }
        main {
            position: relative;
            /* ---
            THE FIX: 'z-index: 10;' is REMOVED from here.
            ---
            */
        }

        .video-container {
            padding-top: 177.77%;
        }
        @media (min-width: 768px) {
            .video-container {
                padding-top: 56.25%;
            }
        }

        .header-logo {
            height: 32px;
            width: auto;
        }
        [x-cloak] { display: none !important; }
    </style>
</head>

<body class="flex flex-col min-h-screen {% if request.endpoint == 'main.index' %}public-bg{% endif %}">
    
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="bg-heritage-green h-1.5"></div>
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16 relative">
            
            <div class="flex-shrink-0 flex items-center -mt-4 -mb-4">
                <a href="{{ url_for('main.index') }}" title="Home" class="flex items-center">
                    <img src="{{ url_for('static', filename='heritage-logo.png') }}" 
                         alt="Heritage Foods Logo" 
                         class="h-20 sm:h-24 md:h-28 w-auto transition-all duration-300"
                         onerror="this.onerror=null;this.src='https://placehold.co/200x60/ffffff/004b8d?text=Heritage+Foods';">
                </a>
            </div>

            <div class="flex items-center space-x-4">
                {% if current_user.is_authenticated %}
                    <span class="hidden sm:inline text-gray-600 text-sm">
                        Welcome, {{ current_user.username }}
                    </span>
                    {% if current_user.role == 'superadmin' %}
                        <a href="{{ url_for('main.superadmin_dashboard') }}" class="text-gray-700 hover:text-heritage-green font-medium">Dashboard</a>
                    {% else %}
                        <a href="{{ url_for('main.qa_dashboard') }}" class="text-gray-700 hover:text-heritage-green font-medium">Dashboard</a>
                    {% endif %}
                    <a href="{{ url_for('main.qa_logout') }}" class="text-gray-700 hover:text-heritage-green font-medium">Logout</a>
                {% else %}
                    <a href="{{ url_for('main.qa_login') }}" 
                       class="bg-heritage-green text-white font-bold py-2 px-5 rounded-lg hover:bg-heritage-green-dark transition-colors shadow-sm text-sm">
                        QA Login
                    </a>
                {% endif %}
            </div>
        </div>
    </nav>
</header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mb-4 space-y-2">
                {% for category, message in messages %}
                <div x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 5000)"
                    class="p-4 rounded-md text-sm"
                    :class="{ 'bg-green-100 border border-green-200 text-green-800': '{{ category }}' === 'success',
                                'bg-red-100 border border-red-200 text-red-800': '{{ category }}' === 'danger',
                                'bg-blue-100 border border-blue-200 text-blue-800': '{{ category }}' === 'info' }">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <div 
        x-data="appModal()" 
        @open-modal.window="open($event.detail.type, $event.detail.title, $event.detail.message)"
        x-show="isOpen"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-[99] flex items-center justify-center p-4" 
        style="display: none;"
    >
        <div class="fixed inset-0 bg-gray-600 bg-opacity-75" @click="cancel()"></div>
        
        <div 
            x-show="isOpen"
            x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="relative bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-md w-full mx-auto z-10"
            @click.outside="cancel()"
        >
            <div class="flex items-start">
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full"
                     :class="{
                        'bg-red-100': type === 'confirm',
                        'bg-blue-100': type === 'alert'
                     }">
                    <svg x-show="isConfirm" class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <svg x-show="!isConfirm" class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                
                <div class="ml-4 text-left">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="title"></h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" x-text="message"></p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button 
                    x-show="isConfirm"
                    @click="cancel()"
                    type="button" 
                    class="bg-gray-200 text-gray-800 font-bold py-2 px-5 rounded-lg hover:bg-gray-300 transition-all shadow-sm">
                    Cancel
                </button>
                <button 
                    @click="accept()"
                    type="button" 
                    class="font-bold py-2 px-5 rounded-lg transition-all shadow-sm"
                    :class="{
                        'bg-heritage-red text-white hover:bg-heritage-red-dark': isConfirm,
                        'bg-heritage-green text-white hover:bg-heritage-green-dark': !isConfirm
                    }">
                    <span x-show="isConfirm">Confirm</span>
                    <span x-show="!isConfirm">OK</span>
                </button>
            </div>
        </div>
    </div>
    <footer class="bg-heritage-green text-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-sm">
            &copy; {{ current_year }} Heritage Foods Limited. All Rights Reserved.
            </div>
        <div class="bg-[#086F3A] h-1.5"></div>
    </footer>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const videoWrapper = document.getElementById('video-wrapper');
        if (videoWrapper) {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            var player;
            window.onYouTubeIframeAPIReady = function() {
                const videoIdToUse = 'oV_1uyA2c0w'; 
                player = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoIdToUse,
                    playerVars: {
                        'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1,
                        'origin': window.location.origin, 'loop': 1, 'playlist': videoIdToUse
                    },
                    events: { 'onReady': onPlayerReady }
                });
            }

            function onPlayerReady(event) {
                event.target.mute();
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            player.playVideo();
                        } else {
                            player.pauseVideo();
                        }
                    });
                }, { threshold: 0.5 });
                observer.observe(videoWrapper);
            }
        }
    });
</script>
{% endblock %}

</body>
</html>