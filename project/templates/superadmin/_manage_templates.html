<div class="grid grid-cols-1 md:grid-cols-3 gap-6" 
     x-data="templateManager()" 
     @set-product-id.window="selectedProductId = $event.detail; fetchTemplates()" 
     x-init="loadMasterParams()">
    
    <div class="md:col-span-2 bg-white p-4 sm:p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Manage Report Templates</h2>
        
        <div>
            <label for="product_select" class="block text-sm font-medium text-gray-700">Select a Product</label>
            <select id="product_select" x-model="selectedProductId" @change="fetchTemplates()" class="mt-1 block w-full">
                <option value="">-- Choose a product to see its templates --</option>
                {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="mt-6 overflow-x-auto border rounded-lg" x-show="!loading && templates.length > 0">
            <table class="min-w-full text-sm divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left font-medium text-gray-600 w-1/12">Order</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-600 w-3/12">Parameter</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-600 w-4/12">Specification</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-600 w-2/12">Method</th>
                        <th class="px-3 py-2 text-center font-medium text-gray-600 w-2/12">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <template x-for="template in templates" :key="template.id">
                        <tr class="hover:bg-gray-50">
                            <!-- Editable Fields: Order and Specification -->
                            <td class="px-3 py-2">
                                <input type="number" x-model.number="template.order" min="1" class="w-12 p-1 border rounded" />
                            </td>
                            <td class="px-3 py-2" x-text="template.parameter"></td>
                            <td class="px-3 py-2">
                                <input type="text" x-model="template.specification" class="w-full p-1 border rounded" />
                            </td>
                            <td class="px-3 py-2" x-text="template.method"></td>

                            <!-- Actions -->
                            <td class="px-3 py-2 text-center space-x-2 whitespace-nowrap">
                                <button type="button" 
                                        @click="updateTemplate(template)" 
                                        class="text-blue-600 hover:text-blue-900 font-medium">
                                    Update
                                </button>

                                <div class="inline">
                                    <button type="button" @click="deleteTemplate(template.id, template.parameter)" class="text-red-600 hover:underline">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div x-show="loading" class="text-center py-10 text-gray-500">Loading...</div>
        <div x-show="!loading && selectedProductId && templates.length === 0" class="text-center py-10 text-gray-500">
            No templates found for this product.
        </div>
        <div x-show="!loading && !selectedProductId" class="text-center py-10 text-gray-500">
            Please select a product.
        </div>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-xl shadow" x-show="selectedProductId">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Add Template</h2>
        <p class="text-sm text-gray-500 mb-3">Add a new test template to the selected product.</p>
        
        <form :action="'/superadmin/templates/add/' + selectedProductId" 
              method="POST" 
              class="space-y-3"
              x-ref="newTemplateForm"
              @submit.prevent="saveTemplate">
            
            <div>
                <label for="parameter_name" class="block text-sm text-gray-600">Parameter</label>
                <input type="text" id="parameter_name" name="parameter" required 
                       class="w-full p-2 border rounded-lg" 
                       list="master-params-list" 
                       x-model="newParameterName" 
                       @change="paramSelected()">
                <datalist id="master-params-list">
                    <template x-for="param in masterParams" :key="param.name">
                        <option :value="param.name"></option>
                    </template>
                </datalist>
            </div>

            <div>
                <label class="block text-sm text-gray-600">Specification</label>
                <input type="text" name="specification" required 
                       class="w-full p-2 border rounded-lg"
                       x-model="newSpecification">
            </div>

            <div>
                <label class="block text-sm text-gray-600">Method</label>
                <input type="text" name="method" required 
                       class="w-full p-2 border rounded-lg" 
                       x-model="newMethodName">
            </div>

            <div>
                <label class="block text-sm text-gray-600">Order (e.g., 1, 2, 3)</label>
                <input type="number" name="order" required 
                       class="w-full p-2 border rounded-lg" 
                       x-model.number="newOrder"
                       min="1">
            </div>

            <button type="submit" class="w-full bg-heritage-green text-white py-2 rounded-lg hover:bg-heritage-green-dark">
                Save Template
            </button>
        </form>
    </div>
</div>

<script>
    function templateManager() {
        return {
            selectedProductId: '',
            templates: [],
            loading: false,
            masterParams: [],
            newParameterName: '',
            newMethodName: '',
            newSpecification: '',
            newOrder: 1,

            fetchTemplates() {
                if (!this.selectedProductId) {
                    this.templates = [];
                    return;
                }
                this.loading = true;
                fetch(`/api/templates/${this.selectedProductId}`)
                    .then(response => response.json())
                    .then(data => {
                        this.templates = data.templates.sort((a, b) => a.order - b.order); 
                        this.newOrder = this.templates.length + 1;
                        this.loading = false;
                    })
                    .catch(() => {
                        this.loading = false;
                        window.app.alert('Error', 'Error loading templates.');
                    });
            },

            loadMasterParams() {
                fetch(`/api/master_parameters`)
                    .then(response => response.json())
                    .then(data => {
                        this.masterParams = data;
                    });
            },
            
            // Auto-fill Method for the ADD form
            paramSelected() {
                const selected = this.masterParams.find(p => p.name === this.newParameterName);
                if (selected) {
                    this.newMethodName = selected.method;
                }
            },
            
            // Function to handle adding a new template (FIXED TO READ 500 ERROR)
            async saveTemplate() {
                const formData = new FormData(this.$refs.newTemplateForm);
                const response = await fetch(`/superadmin/templates/add/${this.selectedProductId}`, {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });
                
                // CRITICAL FIX: Read JSON data regardless of status (500, 400, etc.)
                const data = await response.json().catch(() => ({ 
                    success: false, 
                    error: "Invalid or empty JSON response from server. Check server logs." 
                }));

                if (data.success && response.ok) {
                    // Success Path
                    this.templates.push(data.template);
                    this.templates.sort((a, b) => a.order - b.order);
                    this.newOrder = this.templates.length + 1;
                    this.newParameterName = '';
                    this.newMethodName = '';
                    this.newSpecification = '';

                    window.app.alert('Success', `Template "${data.template.parameter}" added successfully!`);
                } else {
                    // Failure Path: Server returned non-200 status or success=false in JSON
                    let errorMessage = data.error || `Server returned a general error (Status: ${response.status}).`;
                    window.app.alert('Error', errorMessage);
                }
            },

            // Function to handle updating an existing template
            async updateTemplate(template) {
                const confirmed = await window.app.confirm(
                    'Confirm Update',
                    `Are you sure you want to update the Specification and Order for "${template.parameter}"?`
                );

                if (!confirmed) return;

                const response = await fetch(`/superadmin/templates/edit/${template.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Only sending editable fields: specification and order
                        specification: template.specification,
                        order: template.order
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        this.templates.sort((a, b) => a.order - b.order); 
                        window.app.alert('Success', `Specification for "${template.parameter}" updated successfully!`);
                    } else {
                        window.app.alert('Error', data.error || 'Failed to update template.');
                    }
                } else {
                    const contentType = response.headers.get('Content-Type');
                    if (response.status === 401 || (contentType && contentType.includes('text/html'))) {
                        window.app.alert('Session Expired', 'Your session has expired. Please log in again.');
                        setTimeout(() => window.location.reload(), 1500);
                        return;
                    }
                    window.app.alert('Error', 'Server error while updating template.');
                }
            },
            
            async deleteTemplate(templateId, templateName) {
                const confirmed = await window.app.confirm(
                    'Confirm Delete',
                    `Are you sure you want to delete the template: "${templateName}"?`
                );

                if (!confirmed) { return; }

                try {
                    const response = await fetch(`/superadmin/templates/delete/${templateId}`, {
                        method: 'POST',
                        headers: { 'Accept': 'application/json' }
                    });

                    const contentType = response.headers.get('Content-Type');
                    if (response.status === 401 || (contentType && contentType.includes('text/html'))) {
                        window.app.alert('Session Expired', 'Your session has expired. Please log in again.');
                        setTimeout(() => window.location.reload(), 1500);
                        return;
                    }
                    
                    if (response.ok && contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.success) {
                            const index = this.templates.findIndex(t => t.id === templateId);
                            if (index > -1) {
                                this.templates.splice(index, 1);
                            }
                            window.app.alert('Success', `Template "${templateName}" has been deleted.`);
                        } else {
                            throw new Error(data.error || 'Unknown error during deletion');
                        }
                    } else {
                        const responseText = await response.text();
                         if (!responseText.trim()) {
                            const index = this.templates.findIndex(t => t.id === templateId);
                            if (index > -1) { this.templates.splice(index, 1); }
                            window.app.alert('Success', `Template "${templateName}" has been deleted.`);
                            return;
                         } else {
                            throw new Error(`Invalid response format. (Received text: "${responseText.substring(0, 50)}...")`);
                         }
                    }
                } catch (error) {
                    console.error('Delete failed:', error);
                    let message = error.message.includes('Invalid response format')
                        ? "The delete was likely successful, but the server sent back an invalid confirmation. Please reload the page."
                        : `Could not complete action: ${error.message}`;
                        
                    window.app.alert('Error', message);
                }
            }
        }
    }
</script>