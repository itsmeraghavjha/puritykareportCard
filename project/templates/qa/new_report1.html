templates/qa/new_report.html
<!-- The form for QA users to create a new quality report. -->
{% extends "base.html" %}
{% block title %}New Quality Report{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Create New Quality Report</h1>
    
    <form method="POST" action="{{ url_for('main.new_report') }}" enctype="multipart/form-data" class="bg-white p-8 rounded-xl shadow-lg space-y-8" x-data="{ productId: '' }">
        
        <!-- Product Details Section -->
        <fieldset>
            <legend class="text-xl font-semibold text-gray-700 mb-4">1. Product Details</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div>
                    <label for="product_id" class="block text-sm font-medium text-gray-700">Product</label>
                    <select id="product_id" name="product_id" x-model="productId" class="mt-1 block w-full text-lg px-4 py-2 rounded-md border-gray-300 shadow-sm focus:border-heritage-green focus:ring-heritage-green" required>
                        <option value="">Select a product</option>
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="plant_name" class="block text-sm font-medium text-gray-700">Plant Name</label>
                    <div class="mt-1 block w-full text-lg px-4 py-2 rounded-md border-gray-200 bg-gray-100 text-gray-600">
                        {{ current_user.plant_name }}
                    </div>
                </div>
                <div>
                    <label for="batch_code" class="block text-sm font-medium text-gray-700">Batch Code</label>
                    <input type="text" id="batch_code" name="batch_code" class="mt-1 block w-full text-lg px-4 py-2 rounded-md border-gray-300 shadow-sm focus:border-heritage-green focus:ring-heritage-green uppercase" required>
                </div>
                <div>
                    <label for="expiry_date" class="block text-sm font-medium text-gray-700">Expiry Date</label>
                    <input type="date" id="expiry_date" name="expiry_date" class="mt-1 block w-full text-lg px-4 py-2 rounded-md border-gray-300 shadow-sm focus:border-heritage-green focus:ring-heritage-green" required>
                </div>
            </div>
        </fieldset>

        <!-- Test Results Section -->
        <div id="results-section" class="pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Test Results</h2>
            <div id="results-table-container" class="space-y-4">
                <template x-if="!productId">
                    <p class="text-gray-500 text-center py-8">Please select a product to load the test parameters.</p>
                </template>
                <template x-if="productId">
                    <div x-init="fetchTemplates(productId)">
                        <!-- Dynamic content will be inserted here by Alpine.js -->
                    </div>
                </template>
            </div>
        </div>

        <!-- Signature & Actions -->
        <div class="pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center">
             <div class="text-center sm:text-left">
                <h3 class="font-semibold text-gray-700">Signature on File</h3>
                <p class="text-sm text-gray-500">This signature will be automatically applied.</p>
             </div>
            <div class="flex items-center mt-4 sm:mt-0">
                {% if current_user.signature_filename %}
                    <img src="{{ url_for('main.uploaded_file', filename=current_user.signature_filename) }}" alt="Your Signature" class="h-12 mr-6">
                {% endif %}
                <a href="{{ url_for('main.qa_dashboard') }}" class="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 mr-4 transition-all shadow-md">Cancel</a>
                <button type="submit" class="bg-heritage-green text-white font-bold py-3 px-6 rounded-lg hover:bg-heritage-green-dark transition-all shadow-md">
                    Save Report
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    function fetchTemplates(productId) {
        const container = document.getElementById('results-table-container');
        container.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Loading...</p></div>';

        if (!productId) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Please select a product to load the test parameters.</p>';
            return;
        }

        fetch(`/api/templates/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                let tableHtml = `
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-1/12">S.No.</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Parameter</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Specification</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-1/3">Result</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                if (data.templates && data.templates.length > 0) {
                    data.templates.forEach((template, index) => { // Added index for serial number
                        tableHtml += `
                            <tr class="align-top">
                                <td class="px-4 py-3 text-sm text-gray-700 font-medium">${index + 1}</td> <!-- Dynamically generated Serial No. -->
                                <td class="px-4 py-3 text-sm text-gray-700 font-medium">${template.parameter}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">${template.specification}</td>
                                <td class="px-4 py-3">
                                    <input type="text" name="result-${template.id}" class="block w-full rounded-md border-gray-300 shadow-sm text-sm focus:border-heritage-green focus:ring-heritage-green" required>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tableHtml += `
                        <tr>
                            <td colspan="4" class="px-4 py-3 text-center text-sm text-gray-500">
                                No test templates found for this product.
                            </td>
                        </tr>
                    `;
                }

                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
            })
            .catch(error => {
                console.error('Error fetching templates:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load test parameters. Please try again.</p>';
            });
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('reportForm', () => ({
            productId: '',
            init() {
                this.$watch('productId', (value) => {
                    fetchTemplates(value);
                });
            }
        }));
    });
</script>
{% endblock %}
